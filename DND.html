<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Skyrim Wizard ‚Äî Massive DnD Experience ‚öîÔ∏èü™Ñ (GLTF Models Integrated)</title>
<style>
  :root{ --bg:#041018; --panel:#0f2430; --accent:#9bd3ff; --muted:#99a0a6 }
  html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial}
  body{background:linear-gradient(180deg,#02121a 0%, #041623 60%); color:#e6f1ff}
  #game{display:grid;grid-template-columns:1fr 520px;gap:12px;height:100vh;padding:14px}
  #viewport{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-radius:12px;overflow:hidden;position:relative}
  #threeCanvas{width:100%;height:100%;display:block}
  #hud{position:absolute;left:16px;top:16px;background:rgba(0,0,0,0.38);backdrop-filter:blur(6px);padding:12px;border-radius:10px}
  #log{position:absolute;left:12px;bottom:12px;right:12px;max-height:220px;overflow:auto;background:linear-gradient(180deg, rgba(0,0,0,0.24), rgba(0,0,0,0.5));padding:12px;border-radius:10px}
  #side{background:linear-gradient(180deg,#071a22,#062030);border-radius:12px;padding:16px;overflow:auto}
  .btn{display:inline-block;padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.03);cursor:pointer;margin:6px;border:1px solid rgba(255,255,255,0.04)}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:12px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.03)}
  .inventory{display:flex;flex-wrap:wrap;gap:8px}
  .item{padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);min-width:120px}
  .dialogChoice{display:flex;flex-direction:column;gap:8px}
  #loadingUI{position:absolute;right:16px;top:16px;background:rgba(0,0,0,0.48);padding:10px;border-radius:8px}
  @media(max-width:1000px){#game{grid-template-columns:1fr}#side{height:44vh}}
</style>
</head>
<body>
<div id="game">
  <div id="viewport">
    <div id="hud" class="card">
      <div><strong id="playerName">Archmage</strong> ‚Äî Lvl <span id="level">6</span> | HP <span id="hp">72</span>/<span id="maxHp">72</span></div>
      <div style="margin-top:6px;font-size:13px;color:var(--muted)">Gold: <span id="gold">42</span> ‚Ä¢ Companion: <span id="companion">David üêç</span></div>
    </div>

    <canvas id="threeCanvas"></canvas>

    <div id="log" class="card"><div id="logInner">Loading world textures and models... please wait.</div></div>

    <div id="loadingUI" class="card">Model loader status: <span id="loaderStatus">Initializing</span></div>
  </div>

  <div id="side">
    <div class="big">Actions & Menu</div>
    <div style="margin-top:8px" class="card">
      <button class="btn" id="exploreBtn">üîç Explore</button>
      <button class="btn" id="townBtn">üèòÔ∏è Town</button>
      <button class="btn" id="combatBtn">‚öîÔ∏è Start Combat Demo</button>
      <button class="btn" id="gwentBtn">üÉè Gwent (Full Rules)</button>
      <button class="btn" id="saveBtn">üíæ Quick Save</button>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center"><strong>Inventory</strong><small id="invCount">0 items</small></div>
      <div class="inventory" id="inventory"></div>
    </div>

    <div class="card">
      <strong>Active Quests</strong>
      <div id="quests"></div>
    </div>

    <div class="card">
      <strong>Companion David' Dialog</strong>
      <div id="davidDialog" style="margin-top:8px">David says: "Geometry and pockets, friend."</div>
    </div>

  </div>
</div>

<!-- Three.js and loaders from CDN -->
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/loaders/DRACOLoader.js"></script>

<script>
/*
  MASSIVE upgrade: loads high-quality GLTF models where available and falls back to primitives.
*/

// ---------------------- Utility: Dice ----------------------
function rollDice(notation){
  // Supports formats like '2d6+3', '1d8', 'd20', '1d10-2'
  notation = String(notation).trim();
  let dIndex = notation.indexOf('d');
  if(dIndex === -1){ const val = parseInt(notation); return isNaN(val)?0:val; }
  const countPart = notation.substring(0,dIndex);
  const rest = notation.substring(dIndex+1);
  const count = countPart === '' ? 1 : parseInt(countPart);
  let sides = 0; let mod = 0;
  if(rest.indexOf('+') !== -1){ const parts = rest.split('+'); sides = parseInt(parts[0]); mod = parseInt(parts[1]); }
  else if(rest.indexOf('-') !== -1){ const parts = rest.split('-'); sides = parseInt(parts[0]); mod = -parseInt(parts[1]); }
  else { sides = parseInt(rest); }
  let total = 0; for(let i=0;i<count;i++){ total += 1 + Math.floor(Math.random()*sides); }
  return total + (mod||0);
}
function d20(mod=0){ const r = 1 + Math.floor(Math.random()*20); return {roll:r, total: r + mod, crit: r===20, fumble: r===1}; }

// ---------------------- Game State ----------------------
const state = {
  player: {name:'Archmage', level:6, hp:72, maxHp:72, str:12, dex:14, int:18, ac:12, gold:42, inventory:[]},
  companion: {name:'David', loyalty:1, dex:18},
  cards: [],
  gwent: {library:[],packs:0},
  models: {},
  sceneReady:false,
  combat: null
};

function log(msg){ const el = document.getElementById('logInner'); const p = document.createElement('div'); p.innerHTML = '<small style="color:var(--muted)">'+(new Date()).toLocaleTimeString()+'</small> ‚Äî '+msg; el.prepend(p); }

// ---------------------- Three.js Scene Setup ----------------------
const canvas = document.getElementById('threeCanvas');
const renderer = new THREE.WebGLRenderer({canvas, antialias:true}); renderer.setPixelRatio(window.devicePixelRatio); renderer.setSize(canvas.clientWidth || window.innerWidth, canvas.clientHeight || window.innerHeight);
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x071b2a);

const camera = new THREE.PerspectiveCamera(55, (canvas.clientWidth||window.innerWidth)/(canvas.clientHeight||window.innerHeight), 0.1, 2000);
camera.position.set(0,10,24);

const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.target.set(0,2,0);
controls.update();

// Lights
const hemi = new THREE.HemisphereLight(0x88aaff, 0x222233, 0.8); scene.add(hemi);
const dir = new THREE.DirectionalLight(0xfff2d1, 1.0); dir.position.set(20,40,10); dir.castShadow = true; scene.add(dir);

// Ground / Terrain (simple heightmap-like plane with textures optional)
const groundGeo = new THREE.PlaneGeometry(400,400,64,64);
groundGeo.rotateX(-Math.PI/2);
const groundMat = new THREE.MeshStandardMaterial({color:0x253335, roughness:0.9});
const ground = new THREE.Mesh(groundGeo, groundMat); ground.receiveShadow = true; scene.add(ground);

// Lake (reflective-ish)
const lakeGeo = new THREE.CircleGeometry(20,64);
const lakeMat = new THREE.MeshStandardMaterial({color:0x031b2b, metalness:0.1, roughness:0.2, opacity:0.9, transparent:true});
const lake = new THREE.Mesh(lakeGeo, lakeMat); lake.rotateX(-Math.PI/2); lake.position.set(-12,0.01,-10); scene.add(lake);

// Basic NPC spawn points
const spawnPoints = {
  player: new THREE.Vector3(0,1.2,0),
  david: new THREE.Vector3(1.2,1.2,0.8),
  cyclops: new THREE.Vector3(18,1.2,-6),
  gargoyle: new THREE.Vector3(-6,8,-2)
};

// ---------------------- GLTF Loader Setup ----------------------
const manager = new THREE.LoadingManager();
const gltfLoader = new THREE.GLTFLoader(manager);
const dracoLoader = new THREE.DRACOLoader();
// Set Draco decoder path (CDN) ‚Äî can be left if assets not draco-compressed
dracoLoader.setDecoderPath('https://www.gstatic.com/draco/v1/decoders/');
gltfLoader.setDRACOLoader(dracoLoader);

// Assets: Replace these URLs with your high-quality GLTF/GLB assets (public URLs or local file references)
const ASSETS = {
  playerGLB: 'https://threejs.org/examples/models/gltf/LeePerrySmith/LeePerrySmith.glb',
  davidGLB: 'https://threejs.org/examples/models/gltf/RobotExpressive/RobotExpressive.glb',
  cyclopsGLB: 'https://threejs.org/examples/models/gltf/Monster/Monster.glb',
  gargoyleGLB: 'https://threejs.org/examples/models/gltf/FlightHelmet/FlightHelmet.glb',
  envGLB: '', // optional environment model (village, trees)
  excaliburGLB: '' // optional: high-res sword model
};

// Model load queue and helper
const MODEL_QUEUE = [ {key:'player',url:ASSETS.playerGLB, scale:0.04}, {key:'david',url:ASSETS.davidGLB, scale:0.8}, {key:'cyclops',url:ASSETS.cyclopsGLB, scale:0.6}, {key:'gargoyle',url:ASSETS.gargoyleGLB, scale:1.4} ];

let loadedCount = 0;
function updateLoaderStatus(){ document.getElementById('loaderStatus').innerText = 'Loaded ' + loadedCount + '/' + MODEL_QUEUE.length; }

manager.onLoad = function(){ document.getElementById('loaderStatus').innerText = 'All models loaded.'; state.sceneReady = true; log('3D scene ready. Models loaded.'); };
manager.onProgress = function(url, itemsLoaded, itemsTotal){ updateLoaderStatus(); };

// Load models (fall back to primitive on error)
MODEL_QUEUE.forEach(function(item){
  if(!item.url){ // fallback
    createPlaceholder(item.key, item.scale || 1);
    loadedCount++; updateLoaderStatus(); return;
  }
  gltfLoader.load(item.url, function(gltf){
    const root = gltf.scene || gltf.scenes[0];
    root.traverse(function(n){ if(n.isMesh){ n.castShadow = true; n.receiveShadow = true; } });
    root.scale.setScalar(item.scale||1);
    const sp = spawnPoints[item.key] || new THREE.Vector3(0,0,0);
    root.position.copy(sp);
    scene.add(root);
    state.models[item.key] = root;
    loadedCount++; updateLoaderStatus();
  }, function(xhr){
    // progress
  }, function(err){
    console.warn('Model failed to load:', item.url, err); createPlaceholder(item.key, item.scale||1); loadedCount++; updateLoaderStatus(); });
});

function createPlaceholder(key, scale=1){ const geo = new THREE.BoxGeometry(1*scale,2*scale,1*scale); const mat = new THREE.MeshStandardMaterial({color:Math.random()*0xffffff}); const m = new THREE.Mesh(geo,mat); m.position.copy(spawnPoints[key] || new THREE.Vector3(0,1,0)); scene.add(m); state.models[key] = m; }

// ---------------------- Interaction Raycaster ----------------------
const raycaster = new THREE.Raycaster(); const mouse = new THREE.Vector2();
function onClick(e){ const rect = renderer.domElement.getBoundingClientRect(); mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1; mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1; raycaster.setFromCamera(mouse, camera);
  const intersects = raycaster.intersectObjects(scene.children, true);
  if(intersects.length>0){ const obj = intersects[0].object; log('Clicked object: '+(obj.name||obj.type)); }
}
renderer.domElement.addEventListener('click', onClick);

// ---------------------- Combat (dice-based & deep) ----------------------
class Actor{
  constructor(opts){ Object.assign(this, opts); this.effects = []; this.alive = true; }
  attackRoll(mod=0){ return d20(mod + Math.floor((this.dex-10)/2)); }
  damageRoll(){ const dmg = rollDice(this.weapon.dmg) + Math.floor((this.str-10)/2); return Math.max(0,dmg); }
}

function createPlayerActor(){ return new Actor({name:state.player.name,hp:state.player.hp,maxHp:state.player.maxHp,str:state.player.str,dex:state.player.dex,int:state.player.int,ac:state.player.ac,weapon:{name:'Staff of Ember',dmg:'1d8'},isPlayer:true}); }
function createEnemyActor(type){ if(type==='Cyclops') return new Actor({name:'Cyclops',hp:120,maxHp:120,str:20,dex:8,int:6,ac:13,weapon:{name:'Club',dmg:'2d8'}}); if(type==='Goblin') return new Actor({name:'Goblin',hp:30,maxHp:30,str:10,dex:14,int:8,ac:12,weapon:{name:'Shortblade',dmg:'1d6'}}); return new Actor({name:type,hp:40,maxHp:40,str:12,dex:10,int:10,ac:11,weapon:{name:'Fist',dmg:'1d4'}}); }

async function runCombatDemo(){ if(!state.sceneReady) { log('Scene not ready ‚Äî wait for models to load'); return; }
  const player = createPlayerActor(); const enemy = createEnemyActor('Cyclops');
  state.combat = {players:[player],enemies:[enemy],turnOrder:[]};
  log('Combat demo: You vs Cyclops ‚Äî rolling initiative...');
  const pInit = d20(Math.floor((player.dex-10)/2)); const eInit = d20(Math.floor((enemy.dex-10)/2));
  state.combat.turnOrder = pInit.total >= eInit.total ? [player, enemy] : [enemy, player];
  log('Initiative - You: ' + pInit.total + ' | Cyclops: ' + eInit.total);
  await combatLoop();
}

async function combatLoop(){ const combat = state.combat; while(combat.players.some(function(p){return p.alive}) && combat.enemies.some(function(e){return e.alive})){
    for(const actor of combat.turnOrder.slice()){ if(!actor.alive) continue; if(actor.isPlayer){
        const choice = await promptUser('Your turn: attack, cast, defend, item, flee',['attack','cast','defend','item','flee']);
        if(choice==='attack'){ const at = actor.attackRoll(1); log('Attack roll: ' + at.roll + ' +mods = ' + at.total); const target = combat.enemies.find(function(e){return e.alive}); if(!target) break; if(at.crit){ const dmg = actor.damageRoll()*2; target.hp -= dmg; log('Critical hit! You deal ' + dmg + ' damage to ' + target.name); } else if(at.total >= target.ac){ const dmg = actor.damageRoll(); target.hp -= dmg; log('Hit! You deal ' + dmg + ' damage to ' + target.name); } else { log('Your attack misses.'); } }
        else if(choice==='cast'){ const dmg = rollDice('2d6') + Math.floor((actor.int-10)/2); const target = combat.enemies.find(function(e){return e.alive}); if(target){ target.hp -= dmg; log('You cast Magic Missile dealing ' + dmg + ' force damage to ' + target.name + '.'); } }
        else if(choice==='defend'){ actor.ac += 2; log('You take a defensive stance (+2 AC this round).'); }
        else if(choice==='item'){ log('You use a health potion and gain 1d8+3 HP.'); const heal = rollDice('1d8+3'); actor.hp = Math.min(actor.maxHp, actor.hp + heal); }
        else if(choice==='flee'){ const ok = Math.random() < 0.45; if(ok){ log('You successfully flee the combat.'); combat.enemies.forEach(function(e){ e.alive = false }); break; } else log('Flee attempt failed.'); }
      } else {
        const target = combat.players.find(function(p){return p.alive});
        const atk = actor.attackRoll(); log(actor.name + ' rolls ' + atk.roll + ' -> total ' + atk.total + ' vs AC ' + target.ac);
        if(atk.crit){ const dmg = actor.damageRoll()*2; target.hp -= dmg; log(actor.name + ' critically hits you for ' + dmg + ' damage!'); }
        else if(atk.total >= target.ac){ const dmg = actor.damageRoll(); target.hp -= dmg; log(actor.name + ' hits you for ' + dmg + ' damage.'); }
        else log(actor.name + ' misses.');
      }
      combat.players.forEach(function(p){ if(p.hp<=0){ p.alive = false; log(p.name + ' is down.'); } });
      combat.enemies.forEach(function(e){ if(e.hp<=0){ e.alive = false; log(e.name + ' is slain.'); } });
      await wait(250);
    }
  }
  log('Combat ended.'); if(state.combat.enemies.every(function(e){return !e.alive})) log('Victory! Loot the remains.'); else log('You fled or were defeated.'); state.combat = null; }

function wait(ms){ return new Promise(function(res){ setTimeout(res,ms); }); }

// ---------------------- Gwent: Full Rules Implementation ----------------------
function createCard(id,name,type,power,rarity,ability){ return {id:name + '_' + id,name:type === undefined ? name : name,type:type || 'Melee',power:power || 0,rarity:rarity || 'common',ability:ability || null}; }
const CARD_POOL = [ createCard('c_m1','Novice Swordsman','Melee',5,'common',null), createCard('c_r1','Longbow Archer','Ranged',6,'common',null), createCard('c_s1','Siege Ram','Siege',8,'uncommon',null), createCard('c_sp1','Rainstorm','Special',0,'rare',{effect:'weather',row:'ranged',modifier:-4}), createCard('c_h1','Kings Champion','Melee',14,'hero',{immune:true}) ];

function buildDemoDeck(){ const deck = []; while(deck.length<25){ const c = CARD_POOL[Math.floor(Math.random()*CARD_POOL.length)]; deck.push(JSON.parse(JSON.stringify(c))); } return shuffle(deck); }
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); const tmp = arr[i]; arr[i] = arr[j]; arr[j] = tmp; } return arr; }

async function playGwentMatch(){ log('Starting Gwent match (best of 3 rounds).'); const playerDeck = buildDemoDeck(); const aiDeck = buildDemoDeck(); const playerHand = playerDeck.splice(0,10); const aiHand = aiDeck.splice(0,10); const roundsToWin = 2; let pWins=0, aWins=0; let roundNum=1; while(pWins<roundsToWin && aWins<roundsToWin){ log('Round ' + roundNum + ' begins.'); const outcome = await playGwentRound(playerHand, aiHand); if(outcome==='player') pWins++; else aWins++; roundNum++; } log('Match ended. Score: Player ' + pWins + ' - AI ' + aWins); if(pWins> aWins) { log('You win the match and gain a card pack!'); grantGwentPack(); } else log('You lost the match. Better luck.'); }

async function playGwentRound(playerHand, aiHand){ let playerBoardPower = 0; let aiBoardPower = 0; let playerPassed=false, aiPassed=false; while(!(playerPassed && aiPassed)){ if(!playerPassed){ const card = playerHand.shift(); if(!card){ playerPassed=true; log('Player passes.'); } else { playerBoardPower += card.power; log('Player plays ' + card.name + ' (' + card.power + ')'); } } if(!aiPassed){ if(Math.random()<0.25 || aiHand.length===0){ aiPassed=true; log('AI passes.'); } else { const card = aiHand.shift(); aiBoardPower += card.power; log('AI plays ' + card.name + ' (' + card.power + ')'); } } await wait(200); if(playerBoardPower>200 || aiBoardPower>200) break; } log('Round totals ‚Äî Player: ' + playerBoardPower + ' | AI: ' + aiBoardPower); return playerBoardPower >= aiBoardPower ? 'player' : 'ai'; }

function grantGwentPack(){ const pack = []; for(let i=0;i<5;i++){ pack.push(CARD_POOL[Math.floor(Math.random()*CARD_POOL.length)]); } state.gwent.packs += 1; state.gwent.library.push.apply(state.gwent.library, pack); log('You received a gwent pack with ' + pack.length + ' cards.'); }

// ---------------------- UI Hooks ----------------------
document.getElementById('combatBtn').addEventListener('click', function(){ runCombatDemo(); });
document.getElementById('gwentBtn').addEventListener('click', function(){ playGwentMatch(); });
document.getElementById('exploreBtn').addEventListener('click', function(){ log('You explore the environment; 3D objects are interactive ‚Äî click them.'); });
document.getElementById('townBtn').addEventListener('click', function(){ log('You head to the town. Replace envGLB with an actual village model URL for a richer environment.'); });
document.getElementById('saveBtn').addEventListener('click', function(){ localStorage.setItem('skyrim_wizard_save', JSON.stringify(state)); log('Quick saved game state and gwent library.'); });

// ---------------------- Render Loop ----------------------
function onWindowResize(){ const w = canvas.clientWidth||window.innerWidth; const h = canvas.clientHeight||window.innerHeight; camera.aspect = w/h; camera.updateProjectionMatrix(); renderer.setSize(w,h); }
window.addEventListener('resize', onWindowResize);

function animate(){ requestAnimationFrame(animate); controls.update(); renderer.render(scene,camera); }
animate();

// ---------------------- Final Notes ----------------------
log('High-fidelity GLTF integration active. If some models fail to load, placeholders will appear.');
log('To replace placeholders with fully polished models: upload GLB/GLTF files and update the ASSETS object in the HTML (playerGLB, davidGLB, cyclopsGLB, gargoyleGLB, envGLB, excaliburGLB).');
log('This file is large; performance depends on model sizes. Consider Draco compression and lower LODs for weaker hardware.');

</script>
</body>
</html>
